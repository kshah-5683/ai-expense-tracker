<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expense Tracker</title>
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db, auth;
        let userId;
        let expenseListenerUnsubscribe = null; // To stop listener on auth change
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM ELEMENTS ---
        let expenseInput, analyzeButton, loadingOverlay, errorModal, errorText, closeErrorButton;
        let totalExpenseEl, monthlyBreakdownEl, dailyBreakdownEl, expenseTableBody, userIdDisplay;

        // --- STYLES ---
        const style = document.createElement('style');
        style.textContent = `
            body {
                font-family: 'Inter', sans-serif;
            }
            .spinner {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 4px solid #ffffff;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            #loading-overlay {
                transition: opacity 0.3s ease-in-out;
            }
            #error-modal {
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            }
        `;
        document.head.appendChild(style);

        // --- HELPER FUNCTIONS ---

        /**
         * Gets today's date in YYYY-MM-DD format.
         */
        function getTodaysDate() {
            return new Date().toISOString().split('T')[0];
        }

        /**
         * Shows the loading overlay.
         */
        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        /**
         * Shows the error modal with a message.
         */
        function showError(message) {
            if (errorText && errorModal) {
                errorText.textContent = message;
                errorModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            }
        }

        /**
         * Hides the error modal.
         */
        function hideError() {
            if (errorModal) {
                errorModal.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }
        }

        /**
         * Fetches with exponential backoff.
         */
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    console.warn(`Fetch attempt ${i + 1} failed with status: ${response.status}`);
                } catch (error) {
                    console.warn(`Fetch attempt ${i + 1} failed with error:`, error);
                }
                await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
            }
            throw new Error('Failed to fetch from API after several retries.');
        }

        // --- AI AGENT 1: Unstructured Text to Structured JSON ---

        /**
         * Calls Gemini API to parse raw text into structured expense data.
         * @param {string} rawText - The unstructured text from the user.
         * @returns {Promise<Array<Object>>} A promise that resolves to an array of expense objects.
         */
        async function getStructuredExpenses(rawText) {
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert financial assistant. Your task is to extract expense information from unstructured text.
            - Today's date is ${getTodaysDate()}. Use this if a date is not specified.
            - Infer the category (e.g., "Food", "Transport", "Utilities", "Entertainment", "Other").
            - Return ONLY a valid JSON array matching the provided schema.
            - Ensure all prices are numbers.
            - Ensure all dates are in "YYYY-MM-DD" format.`;

            const jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "item": { "type": "STRING", "description": "Name or description of the expense item." },
                        "price": { "type": "NUMBER", "description": "Cost of the item." },
                        "date": { "type": "STRING", "description": "Date of the expense in YYYY-MM-DD format." },
                        "category": { "type": "STRING", "description": "Inferred expense category." }
                    },
                    required: ["item", "price", "date", "category"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: rawText }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                }
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                try {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    return parsedJson;
                } catch (e) {
                    console.error("Failed to parse JSON response:", e);
                    throw new Error("AI returned invalid data. Please check the console.");
                }
            } else {
                console.error("Invalid API response structure:", result);
                throw new Error("AI Agent 1 failed. No valid content returned.");
            }
        }

        // --- FIRESTORE (Database) FUNCTIONS ---

        /**
         * Saves the structured expense data to Firestore.
         * @param {Array<Object>} expenses - Array of expense objects from the AI.
         * @param {string} uid - The user's ID.
         */
        async function saveExpensesToFirestore(expenses, uid) {
            if (!db) {
                showError("Database not initialized.");
                return;
            }
            
            const expenseCollectionRef = collection(db, `artifacts/${appId}/users/${uid}/expenses`);
            
            try {
                // Add each expense as a new document
                const promises = expenses.map(expense => addDoc(expenseCollectionRef, expense));
                await Promise.all(promises);
                console.log(`Successfully added ${expenses.length} expenses to Firestore.`);
            } catch (error) {
                console.error("Error saving expenses to Firestore:", error);
                showError(`Failed to save expenses: ${error.message}`);
            }
        }

        // --- "AI AGENT 2" (UI Updater) FUNCTIONS ---

        /**
         * Sets up the real-time listener for expenses.
         * This replaces the need for "AI Agent 2".
         * @param {string} uid - The user's ID.
         */
        function setupExpenseListener(uid) {
            // Unsubscribe from any previous listener
            if (expenseListenerUnsubscribe) {
                expenseListenerUnsubscribe();
            }
            if (!db) return;

            const expenseQuery = query(collection(db, `artifacts/${appId}/users/${uid}/expenses`));
            
            expenseListenerUnsubscribe = onSnapshot(expenseQuery, (snapshot) => {
                const expenses = [];
                snapshot.forEach((doc) => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                // Sort by date, newest first
                expenses.sort((a, b) => b.date.localeCompare(a.date));
                updateUI(expenses);
            }, (error) => {
                console.error("Error with expense listener:", error);
                showError(`Real-time update failed: ${error.message}`);
            });
        }

        /**
         * Updates the entire UI based on the current list of expenses.
         * @param {Array<Object>} expenses - The full list of expenses from Firestore.
         */
        function updateUI(expenses) {
            updateSummaries(expenses);
            updateExpenseTable(expenses);
        }

        /**
         * Calculates and displays total, monthly, and daily summaries.
         * @param {Array<Object>} expenses - The full list of expenses.
         */
        function updateSummaries(expenses) {
            let total = 0;
            const monthly = {};
            const daily = {};

            expenses.forEach(exp => {
                const price = exp.price || 0;
                total += price;

                // Monthly breakdown (e.g., "2025-11")
                const month = exp.date.substring(0, 7);
                monthly[month] = (monthly[month] || 0) + price;

                // Daily breakdown
                const day = exp.date;
                daily[day] = (daily[day] || 0) + price;
            });

            // Update Total
            totalExpenseEl.textContent = `₹${total.toFixed(2)}`;

            // Update Monthly
            monthlyBreakdownEl.innerHTML = '';
            const sortedMonths = Object.keys(monthly).sort().reverse();
            if (sortedMonths.length === 0) {
                monthlyBreakdownEl.innerHTML = `<p class="text-gray-500">No monthly data.</p>`;
            } else {
                sortedMonths.forEach(month => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${month}</span>
                        <span class="text-gray-700">₹${monthly[month].toFixed(2)}</span>
                    `;
                    monthlyBreakdownEl.appendChild(el);
                });
            }

            // Update Daily
            dailyBreakdownEl.innerHTML = '';
            const sortedDays = Object.keys(daily).sort().reverse().slice(0, 10); // Show last 10 days
            if (sortedDays.length === 0) {
                dailyBreakdownEl.innerHTML = `<p class="text-gray-500">No daily data.</p>`;
            } else {
                sortedDays.forEach(day => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${day}</span>
                        <span class="text-gray-700">₹${daily[day].toFixed(2)}</span>
                    `;
                    dailyBreakdownEl.appendChild(el);
                });
            }
        }

        /**
         * Populates the main expense table.
         * @param {Array<Object>} expenses - The full list of expenses (assumed sorted).
         */
        function updateExpenseTable(expenses) {
            expenseTableBody.innerHTML = '';
            if (expenses.length === 0) {
                expenseTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-6 text-gray-500">
                            No expenses found. Add some notes and click "Analyze".
                        </td>
                    </tr>
                `;
                return;
            }

            expenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="py-3 px-4">${exp.date}</td>
                    <td class="py-3 px-4 font-medium">${exp.item}</td>
                    <td class="py-3 px-4">${exp.category}</td>
                    <td class="py-3 px-4 text-right font-medium">₹${(exp.price || 0).toFixed(2)}</td>
                `;
                expenseTableBody.appendChild(tr);
            });
        }

        // --- EVENT HANDLERS ---

        /**
         * Handles the click event for the "Analyze" button.
         * This triggers "AI Agent 1".
         */
        async function handleAnalysisClick() {
            const rawText = expenseInput.value;
            if (!rawText.trim()) {
                showError("Please paste your expense notes first.");
                return;
            }
            if (!userId) {
                showError("User not authenticated. Please wait or refresh.");
                return;
            }

            showLoading();
            analyzeButton.disabled = true;

            try {
                // 1. AI Agent 1: Get structured data
                const structuredData = await getStructuredExpenses(rawText);
                
                if (!structuredData || structuredData.length === 0) {
                    showError("The AI could not find any expenses in your notes.");
                    return;
                }

                // 2. Save to "Excel" (Firestore)
                await saveExpensesToFirestore(structuredData, userId);

                // 3. "AI Agent 2" (onSnapshot) will automatically update the UI.
                expenseInput.value = ''; // Clear input on success
            
            } catch (error) {
                console.error("Analysis failed:", error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                hideLoading();
                analyzeButton.disabled = false;
            }
        }
        
        // --- INITIALIZATION ---
        
        function initApp() {
            // Cache DOM elements
            expenseInput = document.getElementById('expense-input');
            analyzeButton = document.getElementById('analyze-button');
            loadingOverlay = document.getElementById('loading-overlay');
            errorModal = document.getElementById('error-modal');
            errorText = document.getElementById('error-text');
            closeErrorButton = document.getElementById('close-error-button');
            totalExpenseEl = document.getElementById('total-expense');
            monthlyBreakdownEl = document.getElementById('monthly-breakdown');
            dailyBreakdownEl = document.getElementById('daily-breakdown');
            expenseTableBody = document.getElementById('expense-table-body');
            userIdDisplay = document.getElementById('user-id-display');

            // Attach event listeners
            analyzeButton.addEventListener('click', handleAnalysisClick);
            closeErrorButton.addEventListener('click', hideError);

            // Initialize Firebase
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging

                // Set up auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        console.log("User authenticated:", userId);
                        // Start the real-time listener
                        setupExpenseListener(userId);
                    } else {
                        // User is signed out, try to sign in
                        userId = null;
                        if (expenseListenerUnsubscribe) expenseListenerUnsubscribe();
                        userIdDisplay.textContent = 'Authenticating...';
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                console.log("Signing in with custom token...");
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                console.log("Signing in anonymously...");
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            showError(`Authentication failed: ${error.message}`);
                            userIdDisplay.textContent = 'Authentication Failed';
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Application failed to start. Check console.");
            }
        }

        // Wait for the DOM to be fully loaded before initializing
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- User ID Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-2 text-right">
            <span id="user-id-display" class="text-xs font-mono text-gray-500">Initializing...</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Input & Summary -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- AI Input Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h1 class="text-xl font-semibold mb-4">Expense Brain Dump</h1>
                    <p class="text-sm text-gray-600 mb-4">
                        Paste your expense notes from anywhere (Google Docs, Notes, etc.). The AI will read and categorize them.
                    </p>
                    <textarea id="expense-input" rows="10" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="e.g.&#10;- Coffee with client ₹150.50 yesterday&#10;- Groceries at Safeway ₹2300.12 11/01/2025&#10;- Uber ride ₹450.00"></textarea>
                    <button id="analyze-button" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        Analyze Expenses
                    </button>
                </div>

                <!-- Summary Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Total Expenses</h2>
                    <div id="total-expense" class="text-4xl font-bold text-indigo-600">
                        ₹0.00
                    </div>
                </div>

                <!-- Monthly Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Monthly Breakdown</h2>
                    <div id="monthly-breakdown" class="space-y-2 text-sm">
                        <p class="text-gray-500">No monthly data.</p>
                    </div>
                </div>
                
                <!-- Daily Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Recent Daily Breakdown</h2>
                    <div id="daily-breakdown" class="space-y-2 text-sm">
                        <p class="text-gray-500">No daily data.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Expense List -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">All Expenses</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200 text-sm">
                            <tr>
                                <td colspan="4" class="text-center py-6 text-gray-500">
                                    No expenses found. Add some notes and click "Analyze".
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p class="text-white text-lg mt-4">AI Agent 1 is thinking...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none scale-95">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-medium text-red-600">Error</h3>
            <p id="error-text" class="mt-2 text-sm text-gray-700">Something went wrong.</p>
            <div class="mt-4 text-right">
                <button id="close-error-button" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Close
                </button>
            </div>
        </div>
    </div>

</body>
</html>
