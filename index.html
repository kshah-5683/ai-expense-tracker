<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expense Tracker</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- 3. Load jsPDF for PDF Exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- 4. NEW: Load PDF.js for reading PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // Required for PDF.js to find its worker script
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js`;
        }
    </script>
    
    <!-- 5. NEW: Load Mammoth.js for reading .docx files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
    
    <!-- 6. Load Firebase JS libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            setDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase Variables ---
        let db, auth;
        let userId;
        let expenseListenerUnsubscribe = null;
        let allExpenses = []; // Store all expenses globally
        
        // 1. Add your Firebase Config (Check this carefully!)
        const firebaseConfig = {
          apiKey: "AIzaSyDZy2U3T3dPFepklILdR9q3W5XJ3OgRpFY",
          authDomain: "ai-expense-tracker-b8335.firebaseapp.com",
          projectId: "ai-expense-tracker-b8335",
          storageBucket: "ai-expense-tracker-b8335.firebasestorage.app",
          messagingSenderId: "203162708463",
          appId: "1:203162708463:web:3315f19b33bb13a50aee1a",
          measurementId: "G-B8C78G0Q3T"
        };
        
        const appId = 'ai-expense-tracker';

        // --- DOM ELEMENTS ---
        let expenseInput, analyzeButton, errorIndicator, errorMessage, closeErrorButton;
        
        // --- NEW: File Upload Elements ---
        let fileUploadButton, fileUploadInput, fileUploadSpinner, fileUploadLabel;
        
        // --- Page Content Elements ---
        let mainTrackerView, mainDashboardView;
        let trackerTabButton, dashboardTabButton;
        
        // --- Tracker Page Elements ---
        let totalExpenseEl, monthlyBreakdownEl, dailyBreakdownEl, expenseTableBody;
        let downloadDropdown, downloadPdfButton, downloadCsvButton;
        
        // --- Auth UI Elements ---
        let authModal, loginButton, logoutButton, userInfoDisplay, userIdDisplay;
        let loginForm, registerForm, authError, authTabs, loginTab, registerTab;

        // --- Edit Modal Elements ---
        let editModal, editForm, editExpenseId, editDate, editItem, editCategory, editPrice, cancelEditButton;
        
        // --- Delete Modal Elements ---
        let deleteModal, deleteConfirmButton, deleteCancelButton, deleteModalText;
        let expenseToDeleteId = null; // Store ID for delete confirmation
        
        // --- Dashboard Elements ---
        let yearFilter, monthFilter;
        let categoryPieChartEl, categoryPieChart;
        let trendBarChartEl, trendBarChart;
        let dashboardTotalEl;

        // --- Helper: Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Core UI Functions (Tracker Page) ---
        function updateSummaries(expenses) {
            const total = expenses.reduce((sum, exp) => sum + (exp.price || 0), 0);
            const monthly = {};
            const daily = {};

            expenses.forEach(exp => {
                try {
                    const date = new Date(exp.date);
                    if (isNaN(date.getTime())) return; 

                    const month = date.toISOString().slice(0, 7);
                    const day = date.toISOString().slice(0, 10);

                    monthly[month] = (monthly[month] || 0) + exp.price;
                    daily[day] = (daily[day] || 0) + exp.price;
                } catch (e) {
                    console.warn("Skipping expense with invalid date:", exp);
                }
            });

            totalExpenseEl.textContent = `₹${total.toFixed(2)}`;

            monthlyBreakdownEl.innerHTML = '';
            const sortedMonths = Object.keys(monthly).sort().reverse();
             if (sortedMonths.length === 0) {
                monthlyBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm">No monthly data yet.</p>';
            } else {
                sortedMonths.forEach(month => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${month}</span>
                        <span class="text-gray-700">₹${monthly[month].toFixed(2)}</span>
                    `;
                    monthlyBreakdownEl.appendChild(el);
                });
            }

            dailyBreakdownEl.innerHTML = '';
            const sortedDays = Object.keys(daily).sort().reverse();
             if (sortedDays.length === 0) {
                dailyBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm">No daily data yet.</p>';
            } else {
                sortedDays.slice(0, 10).forEach(day => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${day}</span>
                        <span class="text-gray-700">₹${daily[day].toFixed(2)}</span>
                    `;
                    dailyBreakdownEl.appendChild(el);
                });
            }
        }

        function updateExpenseTable(expenses) {
            expenseTableBody.innerHTML = '';
            if (expenses.length === 0) {
                expenseTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">No expenses logged yet.</td></tr>';
                return;
            }
            
            const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedExpenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4">${exp.date}</td>
                    <td class="py-3 px-4 font-medium">${exp.item}</td>
                    <td class="py-3 px-4">${exp.category}</td>
                    <td class="py-3 px-4 text-right font-medium">₹${(exp.price || 0).toFixed(2)}</td>
                    <td class="py-3 px-4 text-center flex justify-center space-x-2">
                        <!-- EDIT BUTTON -->
                        <button class="text-gray-400 hover:text-indigo-600 edit-expense-btn" 
                                data-id="${exp.id}" 
                                data-date="${exp.date}" 
                                data-item="${exp.item}" 
                                data-category="${exp.category}" 
                                data-price="${exp.price}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                            </svg>
                        </button>
                        <!-- DELETE BUTTON -->
                        <button class="text-gray-400 hover:text-red-600 delete-expense-btn" data-id="${exp.id}" data-item="${exp.item}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                expenseTableBody.appendChild(tr);
            });
        }
        
        const debouncedUpdateSummaries = debounce(updateSummaries, 250);
        const debouncedUpdateTable = debounce(updateExpenseTable, 250);

        function showLoading(isLoading) {
            if (isLoading) {
                analyzeButton.disabled = true;
                analyzeButton.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                `;
            } else {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'Analyze Expenses';
            }
        }
        
        // NEW: Show loading spinner for file upload
        function showFileLoading(isLoading) {
            if (isLoading) {
                fileUploadLabel.classList.add('hidden');
                fileUploadSpinner.classList.remove('hidden');
            } else {
                fileUploadLabel.classList.remove('hidden');
                fileUploadSpinner.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorIndicator.classList.remove('hidden');
        }

        function hideError() {
            errorIndicator.classList.add('hidden');
        }

        // --- AI & Data Functions ---

        async function getStructuredExpenses(rawText) {
            const proxyApiUrl = "/api/getExpenses"; 
            
            const response = await fetch(proxyApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rawText: rawText })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "The AI analysis function failed.");
            }

            const result = await response.json();
            
            if (result.expenses) {
                return result.expenses;
            } else {
                 console.error("Invalid response from proxy:", result);
                throw new Error("Failed to get a valid response from the AI function.");
            }
        }

        async function saveExpenseToFirestore(expense) {
            if (!userId) {
                throw new Error("User not authenticated. Please try again.");
            }
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            await addDoc(collection(db, collectionPath), expense);
        }
        
        async function updateExpenseInFirestore(expenseId, updatedData) {
            if (!userId) {
                throw new Error("User not authenticated.");
            }
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            const expenseDocRef = doc(db, collectionPath, expenseId);
            
            await setDoc(expenseDocRef, updatedData, { merge: true });
        }

        async function handleDeleteExpense(expenseId) {
            if (!userId || !expenseId) {
                showError("Invalid user or expense ID.");
                return;
            }
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
                const expenseDocRef = doc(db, collectionPath, expenseId);
                await deleteDoc(expenseDocRef);
            } catch (error) {
                console.error("Error deleting document:", error);
                showError("Failed to delete expense. Please try again.");
            }
        }

        function attachExpenseListener() {
            if (expenseListenerUnsubscribe) {
                expenseListenerUnsubscribe();
            }
            if (!userId) return;

            console.log(`Attaching listener for user: ${userId}`);
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            const q = query(collection(db, collectionPath));

            expenseListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
                console.log("Received data from Firestore.");
                allExpenses = [];
                querySnapshot.forEach((doc) => {
                    allExpenses.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort expenses once
                allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Update everything that depends on this data
                debouncedUpdateTable(allExpenses);
                debouncedUpdateSummaries(allExpenses);
                debouncedUpdateDashboard(allExpenses); // Update charts
                
            }, (error) => {
                console.error("Firestore listener error:", error);
                showError("Error connecting to the database. Please refresh.");
            });
        }
        
        // --- DASHBOARD FUNCTIONS ---
        
        const CHART_COLORS = [
            '#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#3B82F6', '#22C55E', '#D97706', '#DC2626', '#7C3AED', '#6366F1'
        ];
        
        function populateFilters(expenses) {
            const years = new Set();
            const months = new Set();
            expenses.forEach(exp => {
                try {
                    const date = new Date(exp.date);
                    if (isNaN(date.getTime())) return;
                    years.add(date.getFullYear().toString());
                    months.add(date.toISOString().slice(0, 7)); // YYYY-MM
                } catch (e) {}
            });
            
            const sortedYears = Array.from(years).sort().reverse();
            yearFilter.innerHTML = '<option value="all">All Years</option>';
            sortedYears.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            monthFilter.innerHTML = '<option value="all">All Months</option>';
            sortedMonths.forEach(month => {
                monthFilter.innerHTML += `<option value="${month}">${month}</option>`;
            });
        }
        
        function filterExpenses() {
            const selectedYear = yearFilter.value;
            const selectedMonth = monthFilter.value;

            let filtered = allExpenses;

            if (selectedYear !== "all") {
                filtered = filtered.filter(exp => exp.date.startsWith(selectedYear));
            }
            
            if (selectedMonth !== "all") {
                filtered = filtered.filter(exp => exp.date.startsWith(selectedMonth));
            }
            
            return filtered;
        }

        function updateDashboardCharts() {
            const filteredExpenses = filterExpenses();
            
            // 1. Update total
            const total = filteredExpenses.reduce((sum, exp) => sum + (exp.price || 0), 0);
            dashboardTotalEl.textContent = `₹${total.toFixed(2)}`;
            
            // 2. Update Pie Chart
            const categoryData = {};
            filteredExpenses.forEach(exp => {
                const category = exp.category || 'Other';
                categoryData[category] = (categoryData[category] || 0) + exp.price;
            });
            
            const sortedCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            const labels = sortedCategories.map(entry => entry[0]);
            const data = sortedCategories.map(entry => entry[1]);
            
            if (categoryPieChart) categoryPieChart.destroy();
            categoryPieChart = new Chart(categoryPieChartEl, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expenses by Category',
                        data: data,
                        backgroundColor: CHART_COLORS,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Category Breakdown'
                        }
                    }
                }
            });
            
            // 3. Update Bar Chart (Histogram)
            const trendData = {};
            const selectedMonth = monthFilter.value;
            
            filteredExpenses.forEach(exp => {
                 let key;
                 if (selectedMonth !== 'all') {
                     key = exp.date; // Group by day
                 } else {
                     key = exp.date.slice(0, 7); // Group by month
                 }
                 trendData[key] = (trendData[key] || 0) + exp.price;
            });
            
            const sortedTrendData = Object.entries(trendData).sort((a, b) => new Date(a[0]) - new Date(b[0]));
            
            if (trendBarChart) trendBarChart.destroy();
            trendBarChart = new Chart(trendBarChartEl, {
                type: 'bar',
                data: {
                    labels: sortedTrendData.map(entry => entry[0]),
                    datasets: [{
                        label: 'Expenses Over Time',
                        data: sortedTrendData.map(entry => entry[1]),
                        backgroundColor: '#4F46E5',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                           display: false,
                        },
                        title: {
                            display: true,
                            text: selectedMonth !== 'all' ? 'Daily Expense Trend' : 'Monthly Expense Trend'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: selectedMonth !== 'all' ? 'day' : 'month',
                                tooltipFormat: selectedMonth !== 'all' ? 'yyyy-MM-dd' : 'yyyy-MM'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        }
                    }
                }
            });
        }

        // Debounce filter population and chart updates
        const debouncedUpdateDashboard = debounce((expenses) => {
            populateFilters(expenses);
            updateDashboardCharts();
        }, 300);

        // --- Event Handlers ---

        async function handleAnalysisClick() {
            const rawText = expenseInput.value;
            if (!rawText.trim()) {
                showError("Please paste in your expense notes first.");
                return;
            }

            hideError();
            showLoading(true);

            try {
                const expenses = await getStructuredExpenses(rawText);
                
                if (!expenses || expenses.length === 0) {
                    showError("The AI could not find any expenses in your notes.");
                    return;
                }

                const savePromises = expenses.map(exp => saveExpenseToFirestore(exp));
                await Promise.all(savePromises);
                expenseInput.value = '';

            } catch (error) {
                console.error("Analysis failed:", error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // --- DOWNLOAD FUNCTIONS ---
        
        function generateCSV() {
            if (allExpenses.length === 0) {
                showError("No expenses to download.");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Item,Category,Amount\n"; // Header row
            
            allExpenses.forEach(exp => {
                const row = [
                    exp.date,
                    `"${exp.item.replace(/"/g, '""')}"`, // Handle quotes
                    exp.category,
                    exp.price
                ].join(",");
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `expenses_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generatePDF() {
            if (allExpenses.length === 0) {
                showError("No expenses to download.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tableColumn = ["Date", "Item", "Category", "Amount (₹)"];
            const tableRows = [];

            allExpenses.forEach(exp => {
                const expenseData = [
                    exp.date,
                    exp.item,
                    exp.category,
                    exp.price.toFixed(2),
                ];
                tableRows.push(expenseData);
            });
            
            const total = allExpenses.reduce((sum, exp) => sum + (exp.price || 0), 0);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 20,
                didDrawPage: function (data) {
                    // Header
                    doc.setFontSize(20);
                    doc.setTextColor(40);
                    doc.text("Expense Log", data.settings.margin.left, 15);
                },
                // Add a summary footer
                didDrawCell: (data) => {
                    if (data.section === 'body' && data.row.index === allExpenses.length - 1) {
                         doc.setFontSize(12);
                         doc.setFont('helvetica', 'bold');
                         doc.text('Total:', data.settings.margin.left, data.cursor.y + 10);
                         doc.text(`₹${total.toFixed(2)}`, data.table.columns[3].dataKey, data.cursor.y + 10, { align: 'right' });
                    }
                }
            });

            doc.save(`expenses_${new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        // --- NEW: FILE UPLOAD HANDLER ---
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            hideError();
            showFileLoading(true);
            let text = '';

            try {
                if (file.type === 'text/plain') {
                    text = await file.text();
                } else if (file.type === 'application/pdf') {
                    text = await readPdfFile(file);
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    text = await readDocxFile(file);
                } else {
                    throw new Error("Unsupported file type. Please upload .txt, .pdf, or .docx");
                }
                
                // Populate the textarea with the extracted text
                expenseInput.value = (expenseInput.value + '\n\n' + text).trim();

            } catch (error) {
                console.error("File read error:", error);
                showError(error.message);
            } finally {
                showFileLoading(false);
                // Reset file input to allow uploading the same file again
                fileUploadInput.value = null;
            }
        }

        async function readPdfFile(file) {
            const { pdfjsLib } = window;
            if (!pdfjsLib) {
                throw new Error("PDF library (pdf.js) is not loaded.");
            }
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let allText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                allText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            return allText;
        }

        async function readDocxFile(file) {
            const { mammoth } = window;
            if (!mammoth) {
                throw new Error("Word document library (mammoth.js) is not loaded.");
            }
            
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }


        // --- AUTHENTICATION FUNCTIONS ---
        function showAuthModal(show) {
            if (show) {
                authModal.classList.remove('hidden');
            } else {
                authModal.classList.add('hidden');
                authError.textContent = '';
            }
        }

        function switchAuthTab(tab) {
            authError.textContent = '';
            if (tab === 'login') {
                loginTab.classList.add('border-indigo-500', 'text-indigo-600');
                loginTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                registerTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                registerTab.classList.remove('border-indigo-500', 'text-indigo-600');
                
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('border-indigo-500', 'text-indigo-600');
                registerTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                loginTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                loginTab.classList.remove('border-indigo-500', 'text-indigo-600');
                
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Registration failed:", error);
                authError.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                authError.textContent = error.message;
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
                showError("Logout failed. Please try again.");
            }
        }
        
        
        // --- MODAL FUNCTIONS (Edit, Delete) ---
        function showEditModal(show) {
            if (show) {
                editModal.classList.remove('hidden');
            } else {
                editModal.classList.add('hidden');
            }
        }

        function openEditModal(expense) {
            editExpenseId.value = expense.id;
            editDate.value = expense.date;
            editItem.value = expense.item;
            editCategory.value = expense.category;
            editPrice.value = expense.price;
            showEditModal(true);
        }

        async function handleUpdateExpense(e) {
            e.preventDefault();
            
            const expenseId = editExpenseId.value;
            const updatedData = {
                date: editDate.value,
                item: editItem.value,
                category: editCategory.value,
                price: parseFloat(editPrice.value) || 0
            };

            if (!expenseId) {
                showError("Error: No expense ID found.");
                return;
            }

            try {
                await updateExpenseInFirestore(expenseId, updatedData);
                showEditModal(false);
            } catch (error) {
                console.error("Update failed:", error);
                showError("Failed to update expense: " + error.message);
            }
        }

        function showDeleteModal(show) {
            if (show) {
                deleteModal.classList.remove('hidden');
            } else {
                deleteModal.classList.add('hidden');
                expenseToDeleteId = null; // Clear the ID
            }
        }

        function openDeleteModal(expenseId, expenseItem) {
            expenseToDeleteId = expenseId;
            deleteModalText.textContent = `Are you sure you want to delete "${expenseItem}"? This action cannot be undone.`;
            showDeleteModal(true);
        }

        async function handleConfirmDelete() {
            if (expenseToDeleteId) {
                await handleDeleteExpense(expenseToDeleteId);
            }
            showDeleteModal(false);
        }

        // --- PAGE NAVIGATION ---
        function switchMainTab(tab) {
             if (tab === 'tracker') {
                trackerTabButton.classList.add('border-indigo-500', 'text-indigo-600');
                trackerTabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dashboardTabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                dashboardTabButton.classList.remove('border-indigo-500', 'text-indigo-600');
                
                mainTrackerView.classList.remove('hidden');
                mainDashboardView.classList.add('hidden');
             } else {
                dashboardTabButton.classList.add('border-indigo-500', 'text-indigo-600');
                dashboardTabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                trackerTabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                trackerTabButton.classList.remove('border-indigo-500', 'text-indigo-600');
                
                mainDashboardView.classList.remove('hidden');
                mainTrackerView.classList.add('hidden');
                
                // Update dashboard when switching to it
                debouncedUpdateDashboard(allExpenses);
             }
        }
        
        // --- DOWNLOAD DROPDOWN ---
        function toggleDropdown() {
             const menu = document.getElementById('download-menu');
             menu.classList.toggle('hidden');
        }

        // --- Initialization ---

        function initializeAppOnLoad() {
            // Assign DOM elements
            expenseInput = document.getElementById('expense-input');
            analyzeButton = document.getElementById('analyze-button');
            errorIndicator = document.getElementById('error-indicator');
            errorMessage = document.getElementById('error-message');
            closeErrorButton = document.getElementById('close-error-button');
            
            // NEW: File upload
            fileUploadButton = document.getElementById('file-upload-button');
            fileUploadInput = document.getElementById('file-upload-input');
            fileUploadSpinner = document.getElementById('file-upload-spinner');
            fileUploadLabel = document.getElementById('file-upload-label');
            
            // Page content
            mainTrackerView = document.getElementById('main-tracker-view');
            mainDashboardView = document.getElementById('main-dashboard-view');
            trackerTabButton = document.getElementById('tracker-tab-button');
            dashboardTabButton = document.getElementById('dashboard-tab-button');
            
            // Tracker page
            totalExpenseEl = document.getElementById('total-expense');
            monthlyBreakdownEl = document.getElementById('monthly-breakdown');
            dailyBreakdownEl = document.getElementById('daily-breakdown');
            expenseTableBody = document.getElementById('expense-table-body');
            downloadDropdown = document.getElementById('download-dropdown-button');
            downloadPdfButton = document.getElementById('download-pdf-button');
            downloadCsvButton = document.getElementById('download-csv-button');
            
            // Auth
            authModal = document.getElementById('auth-modal');
            loginButton = document.getElementById('login-button');
            logoutButton = document.getElementById('logout-button');
            userInfoDisplay = document.getElementById('user-info-display');
            userIdDisplay = document.getElementById('user-id-display');
            loginForm = document.getElementById('login-form');
            registerForm = document.getElementById('register-form');
            authError = document.getElementById('auth-error');
            authTabs = document.getElementById('auth-tabs');
            loginTab = document.getElementById('login-tab');
            registerTab = document.getElementById('register-tab');
            
            // Edit Modal
            editModal = document.getElementById('edit-modal');
            editForm = document.getElementById('edit-form');
            editExpenseId = document.getElementById('edit-expense-id');
            editDate = document.getElementById('edit-date');
            editItem = document.getElementById('edit-item');
            editCategory = document.getElementById('edit-category');
            editPrice = document.getElementById('edit-price');
            cancelEditButton = document.getElementById('cancel-edit-button');

            // Delete Modal
            deleteModal = document.getElementById('delete-modal');
            deleteConfirmButton = document.getElementById('delete-confirm-button');
            deleteCancelButton = document.getElementById('delete-cancel-button');
            deleteModalText = document.getElementById('delete-modal-text');
            
            // Dashboard
            yearFilter = document.getElementById('dashboard-year-filter');
            monthFilter = document.getElementById('dashboard-month-filter');
            categoryPieChartEl = document.getElementById('category-pie-chart').getContext('2d');
            trendBarChartEl = document.getElementById('trend-bar-chart').getContext('2d');
            dashboardTotalEl = document.getElementById('dashboard-total-expense');

            // --- Attach event listeners ---
            analyzeButton.addEventListener('click', handleAnalysisClick);
            closeErrorButton.addEventListener('click', hideError);
            
            // NEW: File upload
            fileUploadButton.addEventListener('click', () => fileUploadInput.click());
            fileUploadInput.addEventListener('change', handleFileUpload);
            
            // Main tabs
            trackerTabButton.addEventListener('click', () => switchMainTab('tracker'));
            dashboardTabButton.addEventListener('click', () => switchMainTab('dashboard'));
            
            // Download
            downloadDropdown.addEventListener('click', toggleDropdown);
            downloadPdfButton.addEventListener('click', generatePDF);
            downloadCsvButton.addEventListener('click', generateCSV);
            
            // Close dropdown if clicking outside
            window.addEventListener('click', (e) => {
                if (downloadDropdown && !downloadDropdown.contains(e.target)) {
                    document.getElementById('download-menu').classList.add('hidden');
                }
            });
            
            // Auth
            loginButton.addEventListener('click', () => showAuthModal(true));
            logoutButton.addEventListener('click', handleLogout);
            document.getElementById('close-modal-button').addEventListener('click', () => showAuthModal(false));
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            
            // Edit Modal
            editForm.addEventListener('submit', handleUpdateExpense);
            cancelEditButton.addEventListener('click', () => showEditModal(false));
            document.getElementById('close-edit-modal-button').addEventListener('click', () => showEditModal(false));

            // Delete Modal
            deleteConfirmButton.addEventListener('click', handleConfirmDelete);
            deleteCancelButton.addEventListener('click', () => showDeleteModal(false));
            document.getElementById('close-delete-modal-button').addEventListener('click', () => showDeleteModal(false));
            
            // Dashboard Filters
            yearFilter.addEventListener('change', updateDashboardCharts);
            monthFilter.addEventListener('change', (e) => {
                // If a month is chosen, set year to 'all'
                if (e.target.value !== 'all') {
                    yearFilter.value = 'all';
                }
                updateDashboardCharts();
            });


            // Event delegation for edit/delete buttons
            expenseTableBody.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-expense-btn');
                if (deleteButton) {
                    const expenseId = deleteButton.dataset.id;
                    const expenseItem = deleteButton.dataset.item;
                    if (expenseId) {
                        openDeleteModal(expenseId, expenseItem); // Use new modal
                    }
                }
                
                const editButton = e.target.closest('.edit-expense-btn');
                if (editButton) {
                    const expense = { ...editButton.dataset };
                    if (expense.id) {
                        openEditModal(expense);
                    }
                }
            });


            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed. User:", user ? user.uid : 'null');
                    
                    if (expenseListenerUnsubscribe) {
                        expenseListenerUnsubscribe();
                        expenseListenerUnsubscribe = null;
                        console.log("Detached old listener.");
                    }
                    
                    allExpenses = []; // Clear global expenses
                    debouncedUpdateTable([]);
                    debouncedUpdateSummaries([]);
                    debouncedUpdateDashboard(allExpenses); // Clear dashboard

                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userIdDisplay.textContent = user.email;
                        userInfoDisplay.classList.remove('hidden');
                        loginButton.classList.add('hidden');
                        showAuthModal(false);
                        hideError();
                        
                        console.log(`User authenticated: ${user.email}`);
                        attachExpenseListener();
                        
                    } else {
                        // User is signed out.
                        userId = null;
                        userInfoDisplay.classList.add('hidden');
                        loginButton.classList.remove('hidden');
                        showAuthModal(true);
                        switchMainTab('tracker'); // Default to tracker view
                        
                        expenseTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Log in to see your expenses.</td></tr>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Critical error: Could not initialize app. Check Firebase config.");
            }
        }
        
        window.onload = initializeAppOnLoad;

    </script>
    <style>
        .breakdown-list { max-height: 250px; overflow-y: auto; }
        .breakdown-list::-webkit-scrollbar { width: 6px; }
        .breakdown-list::-webkit-scrollbar-track { background: #f1f5f9; }
        .breakdown-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .breakdown-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Ensure charts are responsive but don't overflow */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        /* New style for scrollable table */
        .table-container {
            max-height: 600px; /* Adjust as needed */
            overflow-y: auto;
        }
        /* Sticky header for scrollable table */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            /* FIX: Add a background color to prevent text overlap */
            background-color: #f9fafb; /* This matches thead bg-gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal h-full">

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">Login or Register</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="border-b border-gray-200">
                <nav id="auth-tabs" class="-mb-px flex" aria-label="Tabs">
                    <button id="login-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                        Login
                    </button>
                    <button id="register-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Register
                    </button>
                </nav>
            </div>

            <div class="p-6">
                <p id="auth-error" class="text-sm text-red-600 h-4 mb-4 text-center"></p>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" name="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" name="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Login
                    </button>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" name="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" name="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">Edit Expense</h2>
                <button id="close-edit-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="p-6">
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-expense-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" name="date" id="edit-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-item" class="block text-sm font-medium text-gray-700">Item</label>
                        <input type="text" name="item" id="edit-item" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" name="category" id="edit-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" name="price" id="edit-price" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Cancel
                        </button>
                        <button type="submit" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold text-gray-800">Confirm Deletion</h2>
                <button id="close-delete-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p id="delete-modal-text" class="text-sm text-gray-600">
                            Are you sure you want to delete this expense? This action cannot be undone.
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button id="delete-confirm-button" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button id="delete-cancel-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">AI Expense Tracker</h1>
            
            <!-- Auth UI -->
            <div>
                <button id="login-button" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out hidden">
                    Login
                </button>
                <div id="user-info-display" class="hidden flex items-center space-x-4">
                    <span id="user-id-display" class="text-sm text-gray-600 bg-white py-1 px-3 rounded-full shadow-sm">
                        ...
                    </span>
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-indigo-600">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Error Indicator -->
        <div id="error-indicator" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 shadow-md" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-message" class="block sm:inline">Something went wrong.</span>
            <span id="close-error-button" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <!-- NEW: Main App Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tracker-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                    Tracker
                </button>
                <button id="dashboard-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    Dashboard
                </button>
            </nav>
        </div>
        
        <!-- View 1: Main Tracker (Default View) -->
        <div id="main-tracker-view">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Left Column: Input & Summaries -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-4">Add Expenses</h2>
                        <p class="text-sm text-gray-600 mb-4">
                            Paste notes below or upload a .txt, .pdf, or .docx file.
                        </p>
                        <textarea id="expense-input" rows="8" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="e.g.&#10;- Coffee with client ₹150.50 yesterday&#10;- Groceries at Safeway ₹2300.12 11/01/2025&#10;- Uber ride ₹450.00"></textarea>
                        
                        <!-- NEW: File Upload Button -->
                        <input type="file" id="file-upload-input" class="hidden" accept=".txt,.pdf,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                        <button id="file-upload-button" class="mt-3 w-full bg-white text-indigo-600 font-semibold py-2 px-4 rounded-md border border-indigo-600 shadow-sm hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out flex items-center justify-center">
                            
                            <!-- Upload Icon / Label -->
                            <span id="file-upload-label" class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Upload File
                            </span>
                            
                            <!-- Loading Spinner for File Upload -->
                            <span id="file-upload-spinner" class="hidden flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Reading file...
                            </span>
                        </button>
                        <p class="text-xs text-gray-500 mt-2">To upload a Google Doc, first download it as a .docx file.</p>
                        
                        <!-- Analyze Button -->
                        <button id="analyze-button" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                            Analyze Expenses
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-4">Total Expenses</h2>
                        <div id="total-expense" class="text-4xl font-bold text-indigo-600">
                            ₹0.00
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-4">Monthly Breakdown</h2>
                        <div id="monthly-breakdown" class="breakdown-list space-y-2">
                            <p class="text-gray-500 text-sm">Log in for details.</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-4">Recent Daily Totals</h2>
                        <div id="daily-breakdown" class="breakdown-list space-y-2">
                            <p class="text-gray-500 text-sm">Log in for details.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Expense Table -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        
                        <!-- Log Header with Download -->
                        <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Full Expense Log</h2>
                            
                            <!-- Download Dropdown -->
                            <div class="relative inline-block text-left">
                                <div>
                                    <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" id="download-dropdown-button" aria-haspopup="true" aria-expanded="true">
                                        Download
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                                <div id="download-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20" role="menu" aria-orientation="vertical" aria-labelledby="download-dropdown-button">
                                    <div class="py-1" role="none">
                                        <button id="download-pdf-button" class="text-gray-700 block w-full text-left px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                            Download as PDF
                                        </button>
                                        <button id="download-csv-button" class="text-gray-700 block w-full text-left px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                            Download as CSV (Excel)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scrollable Table Container -->
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                        <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th scope="col" class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="py-4 px-4 text-center text-gray-500">Log in to see your expenses.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- View 2: Dashboard (Hidden by default) -->
        <div id="main-dashboard-view" class="hidden">
            <!-- Filters -->
            <div class="mb-6 p-4 bg-white rounded-lg shadow-md flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="dashboard-year-filter" class="block text-sm font-medium text-gray-700">Filter by Year</label>
                    <select id="dashboard-year-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="all">All Years</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="dashboard-month-filter" class="block text-sm font-medium text-gray-700">Filter by Month</label>
                    <select id="dashboard-month-filter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="all">All Months</option>
                    </select>
                </div>
                <div class="flex-1 bg-indigo-50 p-4 rounded-lg flex flex-col justify-center items-center">
                    <span class="text-sm font-medium text-indigo-700">Total Filtered Expenses</span>
                    <div id="dashboard-total-expense" class="text-3xl font-bold text-indigo-600">
                        ₹0.00
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Pie Chart Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="chart-container">
                        <canvas id="category-pie-chart"></canvas>
                    </div>
                </div>
                <!-- Bar Chart Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="chart-container">
                        <canvas id="trend-bar-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- /container -->

</body>
</html>
