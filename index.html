<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Expense Tracker</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Firebase JS libraries -->
    <script type="module">
        // --- NEW EMAIL AUTH IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- (No more signInAnonymously) ---

        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            setDoc,
            deleteDoc // <-- ADD THIS
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase Variables ---
        let db, auth;
        let userId;
        let expenseListenerUnsubscribe = null; 
        
        // 1. Add your Firebase Config (Check this carefully!)
        // This is the SAME config as before.
        const firebaseConfig = {
          apiKey: "YOUR_FIREBASE_API_KEY", 
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        
        const appId = 'ai-expense-tracker';

        // --- DOM ELEMENTS ---
        let expenseInput, analyzeButton, loadingIndicator, errorIndicator, errorMessage, closeErrorButton;
        let totalExpenseEl, monthlyBreakdownEl, dailyBreakdownEl, expenseTableBody;
        
        // --- NEW AUTH UI ELEMENTS ---
        let authModal, loginButton, logoutButton, userInfoDisplay, userIdDisplay;
        let loginForm, registerForm, authError, authTabs, loginTab, registerTab;

        // --- NEW EDIT UI ELEMENTS ---
        let editModal, editForm, editExpenseId, editDate, editItem, editCategory, editPrice, cancelEditButton;


        // --- Helper: Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Core UI Functions (Unchanged) ---
        function updateSummaries(expenses) {
            const total = expenses.reduce((sum, exp) => sum + (exp.price || 0), 0);
            const monthly = {};
            const daily = {};

            expenses.forEach(exp => {
                try {
                    const date = new Date(exp.date);
                    if (isNaN(date.getTime())) return; 

                    const month = date.toISOString().slice(0, 7);
                    const day = date.toISOString().slice(0, 10);

                    monthly[month] = (monthly[month] || 0) + exp.price;
                    daily[day] = (daily[day] || 0) + exp.price;
                } catch (e) {
                    console.warn("Skipping expense with invalid date:", exp);
                }
            });

            totalExpenseEl.textContent = `₹${total.toFixed(2)}`;

            monthlyBreakdownEl.innerHTML = '';
            const sortedMonths = Object.keys(monthly).sort().reverse();
             if (sortedMonths.length === 0) {
                monthlyBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm">No monthly data yet.</p>';
            } else {
                sortedMonths.forEach(month => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${month}</span>
                        <span class="text-gray-700">₹${monthly[month].toFixed(2)}</span>
                    `;
                    monthlyBreakdownEl.appendChild(el);
                });
            }

            dailyBreakdownEl.innerHTML = '';
            const sortedDays = Object.keys(daily).sort().reverse();
             if (sortedDays.length === 0) {
                dailyBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm">No daily data yet.</p>';
            } else {
                sortedDays.slice(0, 10).forEach(day => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center py-2 border-b";
                    el.innerHTML = `
                        <span class="font-medium">${day}</span>
                        <span class="text-gray-700">₹${daily[day].toFixed(2)}</span>
                    `;
                    dailyBreakdownEl.appendChild(el);
                });
            }
        }

        function updateExpenseTable(expenses) {
            expenseTableBody.innerHTML = '';
            if (expenses.length === 0) {
                expenseTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Log in to see your expenses.</td></tr>';
                return;
            }
            
            const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedExpenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4">${exp.date}</td>
                    <td class="py-3 px-4 font-medium">${exp.item}</td>
                    <td class="py-3 px-4">${exp.category}</td>
                    <td class="py-3 px-4 text-right font-medium">₹${(exp.price || 0).toFixed(2)}</td>
                    <td class="py-3 px-4 text-center flex justify-center space-x-2">
                        <!-- EDIT BUTTON -->
                        <button class="text-gray-400 hover:text-indigo-600 edit-expense-btn" 
                                data-id="${exp.id}" 
                                data-date="${exp.date}" 
                                data-item="${exp.item}" 
                                data-category="${exp.category}" 
                                data-price="${exp.price}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                            </svg>
                        </button>
                        <!-- DELETE BUTTON -->
                        <button class="text-gray-400 hover:text-red-600 delete-expense-btn" data-id="${exp.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                expenseTableBody.appendChild(tr);
            });
        }
        
        const debouncedUpdateSummaries = debounce(updateSummaries, 250);
        const debouncedUpdateTable = debounce(updateExpenseTable, 250);

        function showLoading(isLoading) {
            if (isLoading) {
                analyzeButton.disabled = true;
                analyzeButton.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Analyzing...
                `;
            } else {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'Analyze Expenses';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorIndicator.classList.remove('hidden');
        }

        function hideError() {
            errorIndicator.classList.add('hidden');
        }

        // --- AI & Data Functions (Unchanged) ---

        async function getStructuredExpenses(rawText) {
            const proxyApiUrl = "/api/getExpenses"; 
            
            const response = await fetch(proxyApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rawText: rawText })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "The AI analysis function failed.");
            }

            const result = await response.json();
            
            if (result.expenses) {
                return result.expenses;
            } else {
                 console.error("Invalid response from proxy:", result);
                throw new Error("Failed to get a valid response from the AI function.");
            }
        }

        async function saveExpenseToFirestore(expense) {
            if (!userId) {
                throw new Error("User not authenticated. Please try again.");
            }
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            await addDoc(collection(db, collectionPath), expense);
        }
        
        // --- NEW UPDATE FUNCTION ---
        async function updateExpenseInFirestore(expenseId, updatedData) {
            if (!userId) {
                throw new Error("User not authenticated.");
            }
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            const expenseDocRef = doc(db, collectionPath, expenseId);
            
            // Use setDoc with merge: true to update the document
            await setDoc(expenseDocRef, updatedData, { merge: true });
        }


        // --- NEW DELETE FUNCTION ---
        async function handleDeleteExpense(expenseId) {
            if (!userId) {
                showError("You must be logged in to delete expenses.");
                return;
            }
            if (!expenseId) {
                showError("Invalid expense ID.");
                return;
            }
            
            try {
                // Get the path to the user's private expenses
                const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
                // Create a reference to the specific document
                const expenseDocRef = doc(db, collectionPath, expenseId);
                // Delete the document
                await deleteDoc(expenseDocRef);
                // The onSnapshot listener will automatically update the UI
            } catch (error) {
                console.error("Error deleting document:", error);
                showError("Failed to delete expense. Please try again.");
            }
        }


        function attachExpenseListener() {
            if (expenseListenerUnsubscribe) {
                expenseListenerUnsubscribe();
            }
            
            if (!userId) {
                console.warn("No user ID, cannot attach listener.");
                return;
            }

            console.log(`Attaching listener for user: ${userId}`);
            const collectionPath = `artifacts/${appId}/users/${userId}/expenses`;
            const q = query(collection(db, collectionPath));

            expenseListenerUnsubscribe = onSnapshot(q, (querySnapshot) => {
                console.log("Received data from Firestore.");
                const expenses = [];
                querySnapshot.forEach((doc) => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                debouncedUpdateTable(expenses);
                debouncedUpdateSummaries(expenses);
            }, (error) => {
                console.error("Firestore listener error:", error);
                showError("Error connecting to the database. Please refresh.");
            });
        }

        // --- Event Handlers (Analyze button is Unchanged) ---

        async function handleAnalysisClick() {
            const rawText = expenseInput.value;
            if (!rawText.trim()) {
                showError("Please paste in your expense notes first.");
                return;
            }

            hideError();
            showLoading(true);

            try {
                const expenses = await getStructuredExpenses(rawText);
                
                if (!expenses || expenses.length === 0) {
                    showError("The AI could not find any expenses in your notes.");
                    return;
                }

                const savePromises = expenses.map(exp => saveExpenseToFirestore(exp));
                await Promise.all(savePromises);
                expenseInput.value = '';

            } catch (error) {
                console.error("Analysis failed:", error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // --- NEW AUTHENTICATION FUNCTIONS ---

        /**
         * Toggles the visibility of the authentication modal.
         * @param {boolean} show - Whether to show the modal.
         */
        function showAuthModal(show) {
            if (show) {
                authModal.classList.remove('hidden');
            } else {
                authModal.classList.add('hidden');
                authError.textContent = ''; // Clear errors
            }
        }

        // This is the fix for the SyntaxError
        /**
         * Switches between the Login and Register tabs in the modal.
         * @param {'login' | 'register'} tab - The tab to show.
         */
        function switchAuthTab(tab) {
            authError.textContent = '';
            if (tab === 'login') {
                loginTab.classList.add('border-indigo-500', 'text-indigo-600');
                loginTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                registerTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                registerTab.classList.remove('border-indigo-500', 'text-indigo-600');
                
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('border-indigo-500', 'text-indigo-600');
                registerTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                loginTab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                loginTab.classList.remove('border-indigo-500', 'text-indigo-600');
                
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        /**
         * Handles the user registration form submission.
         */
        async function handleRegister(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle closing the modal
            } catch (error) {
                console.error("Registration failed:", error);
                authError.textContent = error.message;
            }
        }

        /**
         * Handles the user login form submission.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle closing the modal
            } catch (error) {
                console.error("Login failed:", error);
                authError.textContent = error.message;
            }
        }

        /**
         * Handles the user logout click.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle UI cleanup
            } catch (error) {
                console.error("Logout failed:", error);
                showError("Logout failed. Please try again.");
            }
        }
        
        
        // --- NEW EDIT MODAL FUNCTIONS ---

        /**
         * Toggles the visibility of the edit modal.
         * @param {boolean} show - Whether to show the modal.
         */
        function showEditModal(show) {
            if (show) {
                editModal.classList.remove('hidden');
            } else {
                editModal.classList.add('hidden');
            }
        }

        /**
         * Opens the edit modal and pre-fills it with expense data.
         * @param {object} expense - The expense object from the button's dataset.
         */
        function openEditModal(expense) {
            // Fill the form fields
            editExpenseId.value = expense.id;
            editDate.value = expense.date;
            editItem.value = expense.item;
            editCategory.value = expense.category;
            editPrice.value = expense.price;
            
            // Show the modal
            showEditModal(true);
        }

        /**
         * Handles the edit form submission.
         */
        async function handleUpdateExpense(e) {
            e.preventDefault();
            
            const expenseId = editExpenseId.value;
            const updatedData = {
                date: editDate.value,
                item: editItem.value,
                category: editCategory.value,
                price: parseFloat(editPrice.value) || 0
            };

            if (!expenseId) {
                showError("Error: No expense ID found.");
                return;
            }

            try {
                await updateExpenseInFirestore(expenseId, updatedData);
                // onSnapshot will handle the UI update
                showEditModal(false); // Close modal on success
            } catch (error) {
                console.error("Update failed:", error);
                showError("Failed to update expense: " + error.message);
            }
        }


        // --- Initialization ---

        function initializeAppOnLoad() {
            // Assign DOM elements
            expenseInput = document.getElementById('expense-input');
            analyzeButton = document.getElementById('analyze-button');
            loadingIndicator = document.getElementById('loading-indicator');
            errorIndicator = document.getElementById('error-indicator');
            errorMessage = document.getElementById('error-message');
            closeErrorButton = document.getElementById('close-error-button');
            totalExpenseEl = document.getElementById('total-expense');
            monthlyBreakdownEl = document.getElementById('monthly-breakdown');
            dailyBreakdownEl = document.getElementById('daily-breakdown');
            expenseTableBody = document.getElementById('expense-table-body');
            
            // Assign NEW AUTH elements
            authModal = document.getElementById('auth-modal');
            loginButton = document.getElementById('login-button');
            logoutButton = document.getElementById('logout-button');
            userInfoDisplay = document.getElementById('user-info-display');
            userIdDisplay = document.getElementById('user-id-display');
            loginForm = document.getElementById('login-form');
            registerForm = document.getElementById('register-form');
            authError = document.getElementById('auth-error');
            authTabs = document.getElementById('auth-tabs');
            loginTab = document.getElementById('login-tab');
            registerTab = document.getElementById('register-tab');
            
            // Assign NEW EDIT elements
            editModal = document.getElementById('edit-modal');
            editForm = document.getElementById('edit-form');
            editExpenseId = document.getElementById('edit-expense-id');
            editDate = document.getElementById('edit-date');
            editItem = document.getElementById('edit-item');
            editCategory = document.getElementById('edit-category');
            editPrice = document.getElementById('edit-price');
            cancelEditButton = document.getElementById('cancel-edit-button');


            // Attach event listeners
            analyzeButton.addEventListener('click', handleAnalysisClick);
            closeErrorButton.addEventListener('click', hideError);
            
            // Attach NEW AUTH listeners
            loginButton.addEventListener('click', () => showAuthModal(true));
            logoutButton.addEventListener('click', handleLogout);
            document.getElementById('close-modal-button').addEventListener('click', () => showAuthModal(false));
            loginTab.addEventListener('click', () => switchAuthTab('login'));
            registerTab.addEventListener('click', () => switchAuthTab('register'));
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            
            // Attach NEW EDIT listeners
            editForm.addEventListener('submit', handleUpdateExpense);
            cancelEditButton.addEventListener('click', () => showEditModal(false));
            document.getElementById('close-edit-modal-button').addEventListener('click', () => showEditModal(false));


            // --- NEW: Event listener for delete/edit buttons ---
            // Use event delegation on the table body
            expenseTableBody.addEventListener('click', (e) => {
                // Find the closest delete button to the click
                const deleteButton = e.target.closest('.delete-expense-btn');
                if (deleteButton) {
                    const expenseId = deleteButton.dataset.id;
                    if (expenseId) {
                        // We ask for confirmation before deleting
                        // Use a custom modal for confirm instead of window.confirm
                        if (confirm("Are you sure you want to delete this expense?")) {
                             handleDeleteExpense(expenseId);
                        }
                    }
                }
                
                // --- NEW: Event listener for edit buttons ---
                const editButton = e.target.closest('.edit-expense-btn');
                if (editButton) {
                    const expense = { ...editButton.dataset }; // Get all data attributes
                    if (expense.id) {
                        openEditModal(expense);
                    }
                }
            });


            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                
                // setLogLevel('debug');

                // --- UPDATED AUTH STATE LISTENER ---
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed. User:", user ? user.uid : 'null');
                    
                    if (expenseListenerUnsubscribe) {
                        expenseListenerUnsubscribe();
                        expenseListenerUnsubscribe = null;
                        console.log("Detached old listener.");
                    }
                    
                    debouncedUpdateTable([]);
                    debouncedUpdateSummaries([]);

                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userIdDisplay.textContent = user.email; // Show email instead of ID
                        userInfoDisplay.classList.remove('hidden'); // Show user info
                        loginButton.classList.add('hidden');      // Hide login button
                        showAuthModal(false);                     // Hide modal if open
                        hideError();                              // Hide any old errors
                        
                        console.log(`User authenticated: ${user.email}`);
                        attachExpenseListener();
                        
                    } else {
                        // User is signed out.
                        userId = null;
                        userInfoDisplay.classList.add('hidden'); // Hide user info
                        loginButton.classList.remove('hidden');    // Show login button
                        
                        // **CRITICAL:** Show the login modal instead of signing in anonymously
                        showAuthModal(true);
                        
                        // Clear the table and show a login message
                        expenseTableBody.innerHTML = '<tr><td colspan="5" class="py-4 px-4 text-center text-gray-500">Log in to see your expenses.</td></tr>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // This is the error you are probably seeing, caused by bad config
                showError("Critical error: Could not initialize app. Check Firebase config.");
            }
        }
        
        window.onload = initializeAppOnLoad;

    </script>
    <style>
        .breakdown-list { max-height: 250px; overflow-y: auto; }
        .breakdown-list::-webkit-scrollbar { width: 6px; }
        .breakdown-list::-webkit-scrollbar-track { background: #f1f5f9; }
        .breakdown-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .breakdown-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal h-full">

    <!-- NEW: Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <!-- Modal Header -->
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">Login or Register</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav id="auth-tabs" class="-mb-px flex" aria-label="Tabs">
                    <button id="login-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                        Login
                    </button>
                    <button id="register-tab" class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Register
                    </button>
                </nav>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <!-- Auth Error Message -->
                <p id="auth-error" class="text-sm text-red-600 h-4 mb-4 text-center"></p>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" name="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" name="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Login
                    </button>
                </form>

                <!-- Register Form -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input type="email" name="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" name="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW: Edit Expense Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <!-- Modal Header -->
            <div class="flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-semibold">Edit Expense</h2>
                <button id="close-edit-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-expense-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" name="date" id="edit-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-item" class="block text-sm font-medium text-gray-700">Item</label>
                        <input type="text" name="item" id="edit-item" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" name="category" id="edit-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" name="price" id="edit-price" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Cancel
                        </button>
                        <button type="submit" class="w-full sm:w-auto flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <!-- Header -->
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">AI Expense Tracker</h1>
            
            <!-- UPDATED: Auth UI -->
            <div>
                <button id="login-button" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-indigo-7V00 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out hidden">
                    Login
                </button>
                <div id="user-info-display" class="hidden flex items-center space-x-4">
                    <span id="user-id-display" class="text-sm text-gray-600 bg-white py-1 px-3 rounded-full shadow-sm">
                        ...
                    </span>
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-indigo-600">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Error Indicator (Unchanged) -->
        <div id="error-indicator" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 shadow-md" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-message" class="block sm:inline">Something went wrong.</span>
            <span id="close-error-button" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <!-- Main Content Grid (Unchanged) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Input & Summaries -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Input Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Add Expenses</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Paste your expense notes from anywhere. The AI will read and categorize them.
                    </p>
                    <textarea id="expense-input" rows="10" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="e.g.&#10;- Coffee with client ₹150.50 yesterday&#10;- Groceries at Safeway ₹2300.12 11/01/2025&#10;- Uber ride ₹450.00"></textarea>
                    <button id="analyze-button" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        Analyze Expenses
                    </button>
                </div>

                <!-- Summary Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Total Expenses</h2>
                    <div id="total-expense" class="text-4xl font-bold text-indigo-600">
                        ₹0.00
                    </div>
                </div>

                <!-- Monthly Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Monthly Breakdown</h2>
                    <div id="monthly-breakdown" class="breakdown-list space-y-2">
                        <p class="text-gray-500 text-sm">Log in for details.</p>
                    </div>
                </div>

                <!-- Daily Card -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Recent Daily Totals</h2>
                    <div id="daily-breakdown" class="breakdown-list space-y-2">
                        <p class="text-gray-500 text-sm">Log in for details.</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Expense Table -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <h2 class="text-lg font-semibold p-6 border-b">Full Expense Log</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th scope="col" class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th scope="col" class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <!-- UPDATE COLSPAN TO 5 -->
                                    <td colspan="5" class="py-4 px-4 text-center text-gray-500">Log in to see your expenses.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div> <!-- /grid -->
    </div> <!-- /container -->

</body>
</html>
